<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Panel - Ale Importadora</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
:root{ --bg:#f6f8fb; --text:#111; --accent:#FFB800; --accent-dark:#e0a200; --danger:#ff4d4d; }
*{box-sizing:border-box}
body{background:var(--bg);font-family:Inter,sans-serif;color:var(--text);margin:0;padding:20px;}

.container{ max-width:1400px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:30px; }
@media (max-width:900px){ .container{grid-template-columns:1fr} }

.card{ background:#fff; padding:30px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
h2{ margin-top:0; text-align:center; font-weight:900; }

/* FORMULARIO */
.form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:15px; }
.full{ grid-column:1/-1; }
label{ display:block; margin-bottom:5px; font-weight:700; font-size:0.9rem; color:#555; }
input{ width:100%; padding:10px; border:2px solid #eee; border-radius:8px; font-size:1rem; transition:0.2s; outline:none; }
input:focus{ border-color:var(--accent); }

/* FOTOS */
.photo-area{ display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px; }
.photo-box{ 
    border:2px dashed #ddd; border-radius:10px; height:150px; 
    display:flex; flex-direction:column; align-items:center; justify-content:center; 
    cursor:pointer; color:#aaa; transition:0.2s; position:relative; overflow:hidden;
}
.photo-box:hover{ border-color:var(--accent); color:var(--accent-dark); background:#fffdf5; }
.photo-box img{ width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0; }
.photo-box.has-img i, .photo-box.has-img span { display:none; } /* Ocultar icono si hay foto */

.btn-save{ 
    background:var(--accent); color:#000; border:none; padding:15px; 
    width:100%; border-radius:10px; font-weight:900; font-size:1.1rem; 
    cursor:pointer; margin-top:20px; transition:0.2s; 
}
.btn-save:hover{ background:var(--accent-dark); transform:translateY(-2px); }

/* LISTA Y BUSCADOR */
.search-box{ display:flex; gap:10px; margin-bottom:20px; }
.search-box input{ border-radius:8px; }
.btn-search{ background:#000; color:#fff; border:none; border-radius:8px; width:50px; cursor:pointer; }

.item-list{ display:flex; flex-direction:column; gap:10px; max-height:600px; overflow-y:auto; }
.item{ display:flex; gap:12px; background:#fff; border:1px solid #eee; padding:10px; border-radius:10px; align-items:center; }
.item img{ width:50px; height:50px; object-fit:cover; border-radius:6px; background:#f0f0f0; }
.item-info{ flex:1; }
.item-title{ font-weight:700; font-size:0.95rem; }
.item-sub{ font-size:0.8rem; color:#888; }
.actions{ display:flex; gap:8px; }
.btn-act{ border:none; width:32px; height:32px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.edit{ background:#eef2ff; color:#4f46e5; }
.del{ background:#fff1f2; color:#e11d48; }

/* LOADING */
#loadingOverlay {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(255,255,255,0.8); z-index:999;
    display:none; justify-content:center; align-items:center;
    font-weight:bold; font-size:1.5rem;
}
</style>
</head>
<body>

<div id="loadingOverlay">Procesando...</div>

<div class="container">
    <!-- COLUMNA IZQUIERDA: FORMULARIO -->
    <div class="card">
        <h2>Nuevo Producto</h2>
        <form id="prodForm" onsubmit="event.preventDefault(); guardar();">
            <input type="hidden" id="editId">
            
            <div class="form-grid">
                <div class="full">
                    <label>Nombre / Descripción</label>
                    <input id="desc" required placeholder="Ej: Plancha de Cabello Nano Titanium">
                </div>
                
                <div>
                    <label>Categoría (Grande)</label>
                    <input id="cat" required placeholder="Ej: Belleza y salud">
                </div>
                <div>
                    <label>Tipo (Detalle)</label>
                    <input id="tipo" placeholder="Ej: Planchas">
                </div>
                
                <div>
                    <label>Código</label>
                    <input id="code" required placeholder="Ej: JH05">
                </div>
                <div>
                    <label>MOQ</label>
                    <input id="moq" type="number" value="6" placeholder="Mínimo">
                </div>
                
                <div>
                    <label>P. Unidad (Opcional)</label>
                    <input id="punit" type="number" step="0.01">
                </div>
                <div>
                    <label>Precio Mayor (Bs)</label>
                    <input id="pmayor" required type="number" step="0.01">
                </div>
            </div>

            <div class="photo-area">
                <!-- Foto 1 -->
                <div class="photo-box" id="box1" onclick="document.getElementById('file1').click()">
                    <i class="bi bi-camera-fill" style="font-size:2rem; margin-bottom:5px;"></i>
                    <span>Principal</span>
                    <img id="preview1" style="display:none">
                </div>
                <input type="file" id="file1" hidden accept="image/*" onchange="preview(this, 'preview1', 'box1')">

                <!-- Foto 2 -->
                <div class="photo-box" id="box2" onclick="document.getElementById('file2').click()">
                    <i class="bi bi-camera-fill" style="font-size:2rem; margin-bottom:5px;"></i>
                    <span>Secundaria</span>
                    <img id="preview2" style="display:none">
                </div>
                <input type="file" id="file2" hidden accept="image/*" onchange="preview(this, 'preview2', 'box2')">
            </div>

            <button class="btn-save" type="submit">Guardar Producto</button>
            <button type="button" onclick="limpiar()" style="background:transparent; border:none; width:100%; color:#888; margin-top:10px; cursor:pointer;">Cancelar / Limpiar</button>
        </form>
    </div>

    <!-- COLUMNA DERECHA: LISTADO -->
    <div class="card">
        <h2>Buscador</h2>
        <div class="search-box">
            <input id="searcher" placeholder="Buscar por nombre o código..." style="flex:1">
            <button class="btn-search"><i class="bi bi-search"></i></button>
        </div>
        
        <div id="listado" class="item-list">
            <div style="text-align:center; color:#999; padding:20px;">Cargando productos...</div>
        </div>
    </div>
</div>

<script type="module">
import { Client, Databases, Storage, ID, Query } from "https://cdn.jsdelivr.net/npm/appwrite@14.0.1/+esm";

// CREDENCIALES
const PROJECT_ID = '692ee6b70012153cd33c'; 
const DATABASE_ID = '692ee774002e9a3c8601'; 
const COLLECTION_ID = 'catalogo';
const BUCKET_ID = '67a284690020d202d088'; // Asumiendo que usas un bucket de storage, si no tienes el ID a mano, avísame. Si usas URLs externas, esto cambia.

// INICIALIZAR
const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject(PROJECT_ID);
const db = new Databases(client);
const storage = new Storage(client);

let productos = [];
let img1File = null;
let img2File = null;

// --- FUNCIONES GLOBALES ---

window.preview = function(input, imgId, boxId){
    if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = function(e){
            const img = document.getElementById(imgId);
            img.src = e.target.result;
            img.style.display = 'block';
            document.getElementById(boxId).classList.add('has-img');
        }
        reader.readAsDataURL(input.files[0]);
        if(imgId === 'preview1') img1File = input.files[0];
        if(imgId === 'preview2') img2File = input.files[0];
    }
}

window.limpiar = function(){
    document.getElementById('prodForm').reset();
    document.getElementById('editId').value = '';
    document.getElementById('preview1').src = ''; document.getElementById('preview1').style.display='none';
    document.getElementById('preview2').src = ''; document.getElementById('preview2').style.display='none';
    document.getElementById('box1').classList.remove('has-img');
    document.getElementById('box2').classList.remove('has-img');
    img1File = null; img2File = null;
    document.querySelector('.btn-save').textContent = 'Guardar Producto';
}

window.cargar = async function(){
    try {
        // AQUÍ ESTÁ EL ARREGLO: Limit 5000
        const res = await db.listDocuments(DATABASE_ID, COLLECTION_ID, [
            Query.limit(5000), 
            Query.orderDesc('$createdAt')
        ]);
        productos = res.documents;
        render(productos);
    } catch(e){
        alert("Error cargando: " + e.message);
    }
}

function render(lista){
    const div = document.getElementById('listado');
    if(lista.length === 0) { div.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa">No se encontraron productos</div>'; return; }
    
    div.innerHTML = lista.map(p => `
        <div class="item">
            <img src="${p.imagen}">
            <div class="item-info">
                <div class="item-title">${p.descripcion}</div>
                <div class="item-sub">${p.codigo} | ${p.categoria} | Bs. ${p.preciopormayor}</div>
            </div>
            <div class="actions">
                <button class="btn-act edit" onclick="editar('${p.$id}')"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn-act del" onclick="borrar('${p.$id}')"><i class="bi bi-trash-fill"></i></button>
            </div>
        </div>
    `).join('');
}

// BÚSQUEDA INTELIGENTE
document.getElementById('searcher').addEventListener('input', (e)=>{
    const txt = e.target.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const filtrados = productos.filter(p => {
        const desc = (p.descripcion || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const cod = (p.codigo || '').toLowerCase();
        return desc.includes(txt) || cod.includes(txt);
    });
    render(filtrados);
});

// SUBIR IMAGEN (Helper)
async function subirFoto(file){
    if(!file) return null;
    try {
        const res = await storage.createFile(BUCKET_ID, ID.unique(), file);
        // Construir URL pública
        return `https://fra.cloud.appwrite.io/v1/storage/buckets/${BUCKET_ID}/files/${res.$id}/view?project=${PROJECT_ID}`;
    } catch(e) { console.error(e); return null; }
}

window.guardar = async function(){
    const id = document.getElementById('editId').value;
    const desc = document.getElementById('desc').value;
    const cat = document.getElementById('cat').value;
    const tipo = document.getElementById('tipo').value;
    const code = document.getElementById('code').value;
    const moq = document.getElementById('moq').value;
    const punit = document.getElementById('punit').value;
    const pmayor = document.getElementById('pmayor').value;

    if(!desc || !pmayor){ alert("Faltan datos obligatorios"); return; }
    
    document.getElementById('loadingOverlay').style.display = 'flex';

    try {
        let url1 = null; 
        let url2 = null;

        // Si hay archivos nuevos, subirlos
        if(img1File) url1 = await subirFoto(img1File);
        if(img2File) url2 = await subirFoto(img2File);

        const data = {
            descripcion: desc,
            categoria: cat,
            tipo: tipo,
            codigo: code,
            moq: moq,
            precioUnidad: parseFloat(punit || 0),
            preciopormayor: parseFloat(pmayor),
            disponible: true
        };

        // Si se subieron nuevas fotos, actualizamos los campos. Si no, mantenemos lo que había (en caso de edición)
        // NOTA: En Appwrite, si mandas el campo, lo sobrescribe. 
        // En creación: necesitamos URL. En edición: si url1 es null, no enviamos el campo para no borrar la anterior.
        
        if(id){
            // MODO EDICIÓN
            if(url1) data.imagen = url1;
            if(url2) data.imagen2 = url2;
            await db.updateDocument(DATABASE_ID, COLLECTION_ID, id, data);
            alert("¡Producto actualizado!");
        } else {
            // MODO CREACIÓN
            // Aquí asumo que usas URL. Si no hay foto, ponemos una placeholder o string vacío
            data.imagen = url1 || 'https://via.placeholder.com/300?text=Sin+Foto';
            if(url2) data.imagen2 = url2;
            await db.createDocument(DATABASE_ID, COLLECTION_ID, ID.unique(), data);
            alert("¡Producto creado!");
        }

        limpiar();
        cargar(); // Recargar lista

    } catch(e){
        alert("Error al guardar: " + e.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

window.editar = function(id){
    const p = productos.find(x => x.$id === id);
    if(!p) return;

    document.getElementById('editId').value = p.$id;
    document.getElementById('desc').value = p.descripcion;
    document.getElementById('cat').value = p.categoria;
    document.getElementById('tipo').value = p.tipo || '';
    document.getElementById('code').value = p.codigo;
    document.getElementById('moq').value = p.moq;
    document.getElementById('punit').value = p.precioUnidad;
    document.getElementById('pmayor').value = p.preciopormayor;
    
    // Mostrar previews
    const prev1 = document.getElementById('preview1');
    prev1.src = p.imagen; prev1.style.display = 'block';
    document.getElementById('box1').classList.add('has-img');

    if(p.imagen2){
        const prev2 = document.getElementById('preview2');
        prev2.src = p.imagen2; prev2.style.display = 'block';
        document.getElementById('box2').classList.add('has-img');
    }

    document.querySelector('.btn-save').textContent = 'Actualizar Producto';
    
    // Scroll arriba
    window.scrollTo({top:0, behavior:'smooth'});
}

window.borrar = async function(id){
    if(!confirm("¿Seguro que quieres eliminar este producto?")) return;
    try {
        await db.updateDocument(DATABASE_ID, COLLECTION_ID, id, { disponible: false }); // Soft delete o borrar real:
        // await db.deleteDocument(DATABASE_ID, COLLECTION_ID, id); // Borrado real
        alert("Eliminado");
        cargar();
    } catch(e){ alert(e.message); }
}

// Iniciar
cargar();

</script>
</body>
</html>
