<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cat√°logo Mayorista - Ale Importadora</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
:root{ --bg:#f6f8fb; --text:#111; --accent:#FFB800; --brand-red:#CC0000; --card-border:#e5e5e5; }
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{background:var(--bg);font-family:Inter,system-ui,sans-serif; color:var(--text);}

/* --- HEADER ROJO --- */
.header-oferta{ 
    width:100%; background:var(--brand-red); color:#fff; border-bottom:3px solid #b71c1c; 
    box-shadow:0 4px 10px rgba(0,0,0,.15); overflow:hidden; position:sticky; top:0; z-index:50; 
}
.header-track{ 
    display:flex; gap:40px; white-space:nowrap; animation:marquee 20s linear infinite; 
    padding:12px 0; font-weight:800; font-size:1rem; letter-spacing:1px; text-transform:uppercase; 
}
.header-item{ display:inline-flex; align-items:center; gap:8px; }
.header-item i { color: var(--accent); font-size: 1.2rem; } 
@keyframes marquee{ 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

/* LAYOUT */
.main{ max-width:1400px; margin:0 auto; display:grid; grid-template-columns:240px 1fr; gap:25px; padding:25px; padding-bottom: 100px; }

/* SIDEBAR (SOLO PC) */
.sidebar{ 
    background:#fff; border:1px solid var(--card-border); border-radius:12px; padding:20px; 
    position:sticky; top:80px; 
    max-height: calc(100vh - 100px); 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
}
.sidebar h2{ margin:0 0 15px; font-size:1.1rem; font-weight:900; color: #333; display: flex; align-items: center; gap: 8px; }
#menu-cat{ display:flex; flex-direction:column; gap:6px; overflow-y: auto; padding-bottom: 15px; }
.btn-cat{ background:transparent; color:#555; border:1px solid transparent; font-weight:600; border-radius:8px; padding:10px 12px; cursor:pointer; font-size:0.9rem; text-align:left; transition:.2s; }
.btn-cat:hover{ background:#f1f3f5; color:#000; }
.btn-cat.active{ background:var(--brand-red); color:#fff; font-weight: 700; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); }

/* CHIPS DE SUBCATEGOR√çA */
#sub-chips { display: flex; gap: 8px; flex-wrap: wrap; display: none; }
#sub-chips.visible { display: flex; }
.chip { background: #fff; border: 1px solid #dee2e6; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #666; cursor: pointer; transition: 0.2s; }
.chip:hover { background: #eee; }
.chip.active { background: #333; color: #fff; border-color: #333; }

/* --- MEN√ö M√ìVIL HORIZONTAL (EL BUENO) --- */
.mobile-cats { 
    display: none; /* Oculto en PC */
    gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px;
    scrollbar-width: none; 
}
.mobile-cats::-webkit-scrollbar { display: none; }

.cat-chip {
    background: #fff; border: 1px solid #ddd; padding: 10px 18px; 
    border-radius: 50px; font-weight: 700; color: #444; font-size: 0.85rem;
    white-space: nowrap; cursor: pointer; transition: 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}
.cat-chip.active { background: var(--brand-red); color: #fff; border-color: var(--brand-red); box-shadow: 0 4px 10px rgba(204, 0, 0, 0.3); }

/* TOOLBAR */
.toolbar-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
.toolbar{ background:#fff; border:1px solid var(--card-border); border-radius:12px; padding:10px 15px; display:flex; align-items:center; gap:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
#searchBox{ flex:1; border:none; outline:none; font-size:1rem; padding:5px; color: #333; }
#searchBox:focus{ border-color:var(--accent); }

/* GRID PRODUCTOS */
.grid{display:grid; gap:20px; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));}

/* TARJETA DE PRODUCTO */
.card{ 
    background:#fff; border:1px solid var(--card-border); border-radius:16px; overflow:hidden; 
    position:relative; display:flex; flex-direction:column; 
    padding-bottom: 15px; 
}
.card:hover{transform:translateY(-5px); box-shadow:0 10px 25px rgba(0,0,0,0.08);}

/* ETIQUETA ROJA (-35% OFF) */
.badge-offer {
    position: absolute; top: 12px; left: 12px; z-index: 10;
    background: #e63946; color: #fff;
    padding: 4px 10px; border-radius: 50px;
    font-weight: 800; font-size: 0.75rem; letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(230, 57, 70, 0.4);
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes text-pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

/* IMAGEN */
.img-box { background:#fff; height:220px; position: relative; overflow: hidden; border-bottom: 1px solid #f0f0f0; }
.img-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 100%; width: 100%; scroll-scrollbar-width: none; }
.img-slider::-webkit-scrollbar { display: none; }
.slide { min-width: 100%; height: 100%; scroll-snap-align: center; display: flex; justify-content: center; align-items: center; padding: 10px; }
.prod-img { max-width: 100%; max-height:100%; object-fit:contain; cursor: zoom-in; transition: transform 0.3s; }
.prod-img:hover { transform: scale(1.05); }

/* PUNTOS */
.dot-container { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 15; }
.dot { width: 6px; height: 6px; background-color: rgba(0, 0, 0, 0.2); border-radius: 50%; transition: 0.3s; }
.dot.active { background-color: var(--brand-red); transform: scale(1.3); }

/* INFORMACI√ìN */
.info{padding:15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between;}
.title{font-size:0.95rem; font-weight:800; margin:0 0 4px; line-height:1.3; color:#111;}
.ref{font-size:0.8rem; color:#888; font-weight:600; margin-bottom:10px; display: block;}

.prices-container { margin-bottom: 5px; }

/* PRECIOS */
.price-old { text-decoration: line-through; color: #999; font-size: 0.85rem; margin-right: 6px; }
.price-new { color: #d32f2f; font-weight: 900; font-size: 1.3rem; }
.price-normal { color: #111; font-weight: 900; font-size: 1.2rem; }
.price-label { display: block; font-size: 0.7rem; font-weight: 700; color: #16a34a; margin-bottom: 0px; }
.price-label-normal { font-size: 0.7rem; font-weight: 700; color: #555; text-transform: uppercase; }

/* Texto de "Pide tu Descuento" */
.promo-text { 
    font-size: 0.7rem; color: #16a34a; font-weight: 700; 
    background: #dcfce7; padding: 2px 6px; border-radius: 4px;
    display: inline-block; margin-left: 5px;
    animation: text-pulse 2s infinite;
}

/* Nuevo Estilo para Cotizaci√≥n Mayorista */
.mayorista-cotizar {
    margin-top: 10px; 
    font-size: 0.85rem; 
    color: #444; 
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
    background: #e7f5ff; 
    padding: 8px;
    border-radius: 6px;
    border: 1px dashed #c0e0ff; 
    /* Estilo para que el texto se apile verticalmente */
    flex-direction: column; 
    align-items: flex-start;
}
.mayorista-cotizar i { 
    color: var(--brand-red); 
    font-size: 1.1rem;
    margin-right: 6px; 
    margin-top: 2px;
}
.mayorista-label {
    display: flex;
    align-items: center;
    font-size: 0.9rem; /* Un poco m√°s grande para el texto principal */
    font-weight: 800;
    margin-bottom: 4px;
}
.mayorista-price-row {
    line-height: 1.2;
    /* Estilo para que el precio y el texto "Cada Unidad" est√©n separados */
    display: flex;
    flex-direction: column; 
    align-items: flex-start;
    font-size: 0.9rem;
}
.mayorista-price-row span:last-child {
    /* CORRECCI√ìN DE RUIDO VISUAL */
    margin-top: 0; 
    padding-top: 2px; 
    font-size: 0.85rem; 
    font-weight: 700; 
    color: #444; 
    line-height: 1.2;
}

/* --- ZONA FLOTANTE (Fixed Bottom) --- */
.floating-actions {
    position: fixed; bottom: 20px; right: 20px; z-index: 100;
    display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
}

/* 1. Bot√≥n PRINCIPAL (WHATSAPP - Contacto Directo) */
.btn-order {
    background: #25D366; /* Verde WhatsApp */
    color: #fff; 
    padding: 10px 20px; border-radius: 50px; 
    font-weight: 800; font-size: 0.9rem; 
    text-decoration: none; 
    box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
    display: flex; align-items: center; gap: 8px;
    transition: 0.2s;
    /* ANIMACI√ìN DE PARPADEO APLICADA AQU√ç */
    animation: pulse-green 2s infinite; 
}
.btn-order:hover { transform: scale(1.05); background: #1faa58; animation: none; }

/* Animaci√≥n de pulso verde */
@keyframes pulse-green { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(37, 211, 102, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }


/* 2. Bot√≥n GRUPO VIP (Rojo, Secundario - AJUSTADO) */
.btn-group { 
    background: #D32F2F; /* Rojo */
    color: #fff; 
    border: 2px solid #D32F2F;
    height: 45px; width: 45px; border-radius: 50px; 
    display: flex; align-items: center; justify-content: center;
    text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease; overflow: hidden; white-space: nowrap;
}
.btn-group i { font-size: 1.4rem; margin: 0; }
.btn-group span { 
    opacity: 0; 
    max-width: 0; 
    transition: all 0.3s; 
    margin-left: 10px; 
    font-weight: 800; /* M√°s audaz */
    font-size: 1rem; /* M√°s grande */
    color: #fff; 
}
.btn-group:hover { width: 170px; padding: 0 15px; justify-content: flex-start; background: #b91c1c; } 
.btn-group:hover span { opacity: 1; max-width: 200px; margin-left: 10px; }

/* FOOTER */
.main-footer { max-width:1400px; margin:0 auto; padding: 40px 25px; border-top: 1px solid #e5e5e5; background-color: #ffffff; color: #555; font-size: 0.9rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-top: 40px; }
.footer-col h4 { font-weight: 800; font-size: 1rem; color: #111; margin-bottom: 12px; }
.footer-col p { margin-bottom: 8px; line-height: 1.5; color: #555; font-size: 0.9rem; }
.map-link { color: #007bff; text-decoration: none; font-weight: 600; font-size: 0.85rem; }

/* MODALES */
#zoomModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
#zoomModal.open { display: flex; opacity: 1; }
#zoomImg { max-width: 90%; max-height: 90vh; border-radius: 8px; transform: scale(0.9); transition: transform 0.3s; }
#zoomModal.open #zoomImg { transform: scale(1); }
.close-zoom { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 2rem; cursor: pointer; }

/* --- ADAPTACI√ìN M√ìVIL CORRECTA --- */
@media (max-width:992px){ 
    .main{ display:block; padding:15px; padding-bottom: 120px; }
    .sidebar-wrapper { display: none; } /* OCULTAMOS SIDEBAR DE PC */
    .mobile-cats { display: flex; } /* MOSTRAMOS MENU MOVIL */
}
</style>
</head>
<body>

<div id="company-data" style="display:none;" 
    data-horario="LUNES A DOMINGO: 9:00 - 19:30" 
    data-envios="ENV√çOS A TODO BOLIVIA" 
    data-whatsapp="59161333335">
</div>

<div class="header-oferta">
  <div class="header-track">
    <div class="header-item"><i class="bi bi-fire"></i> LIQUIDACI√ìN DE TEMPORADA</div>
    <div class="header-item"><i class="bi bi-tags-fill"></i> HASTA 35% OFF EN UNIDAD</div>
    <div class="header-item"><i class="bi bi-box-seam"></i> PRECIOS DE LOCURA</div>
    <div class="header-item"><i class="bi bi-truck"></i> ENV√çOS A TODO EL PA√çS</div>
  </div>
</div>

<div class="main">
    <div class="sidebar-wrapper">
        <aside class="sidebar">
            <h2><i class="bi bi-grid-fill" style="color:var(--brand-red)"></i> Categor√≠as</h2>
            <div id="menu-cat"><div style="color:#adb5bd; font-size:0.9rem; text-align:center; padding:20px;">Cargando...</div></div>
        </aside>
    </div>

    <section>
        
        <!-- MEN√ö M√ìVIL (HORIZONTAL SCROLL) -->
        <div id="mobile-cats" class="mobile-cats"></div>

        <div class="toolbar-container">
            <div class="toolbar"><i class="bi bi-search" style="font-size:1.2rem; color:#adb5bd"></i><input id="searchBox" placeholder="¬øQu√© est√°s buscando hoy?"></div>
            <div id="sub-chips"></div>
        </div>
        <div id="productos" class="grid"></div>
    </section>
</div>

<!-- ZONA FLOTANTE (BOTONES GLOBALES) -->
<div class="floating-actions">
    <!-- 1. BOT√ìN PRINCIPAL: WHATSAPP (Contacto Directo) - Parpadea y va al chat personal, con √≠cono de fuego -->
    <a href="https://wa.me/59161333335?text=Hola,%20quisiera%20cotizar%20precios%20de%20sus%20productos." target="_blank" class="btn-order">
        <i class="bi bi-fire"></i> WHATSAPP
    </a>
    <!-- 2. BOT√ìN SECUNDARIO: GRUPO VIP (Se expande y va al grupo) -->
    <a href="https://chat.whatsapp.com/FHPAXOAn2yz4pgaq9t3gZb" target="_blank" class="btn-group">
        <i class="bi bi-people-fill"></i> 
        <span>GRUPO VIP</span>
    </a>
</div>

<footer class="main-footer">
    <div class="footer-col"><h4><i class="bi bi-building"></i> Importadora Ale</h4><p>Tu proveedor mayorista de confianza.</p><p>¬© 2025 Derechos Reservados.</p></div>
    <div class="footer-col"><h4><i class="bi bi-geo-alt-fill"></i> Sucursales</h4><p><b>1:</b> Aroma N.¬∫ 560 ‚Äì Santa Cruz</p><p><b>2:</b> Av. Ca√±oto esq. Tund√≠ #924</p></div>
    <div class="footer-col"><h4><i class="bi bi-headset"></i> Ayuda</h4><p><i class="bi bi-clock"></i> <span id="footer-horario"></span></p><p><i class="bi bi-truck"></i> <span id="footer-envios"></span></p><p><i class="bi bi-whatsapp"></i> <a href="https://wa.me/59161333335" target="_blank" class="text-green-600 font-semibold">61333335</a></p></div>
</footer>

<div id="zoomModal" onclick="closeZoom()"><span class="close-zoom">√ó</span><img id="zoomImg" src="" onclick="event.stopPropagation()"></div>

<script type="module">
import { Client, Databases, Query } from "https://cdn.jsdelivr.net/npm/appwrite@14.0.1/+esm";
const PROJECT_ID = '692ee6b70012153cd33c'; 
const DATABASE_ID = '692ee774002e9a3c8601'; 
const COLLECTION_ID = 'catalogo';
const COMPANY_DATA = document.getElementById('company-data');
const WHATSAPP_NUMBER = COMPANY_DATA.dataset.whatsapp;

// --- CONFIGURACI√ìN DE DESCUENTO ---
const DESCUENTO_UNIDAD_PORCENTAJE = 35; 

// --- CATEGOR√çAS MAESTRAS FIJAS (ESTO BLINDA EL CAT√ÅLOGO) ---
const CATEGORIAS_MAESTRAS = [
    "Todo",
    "Belleza y salud",
    "Herramientas",
    "Hogar y cocina",
    "Infantil",
    "Moda y equipaje",
    "Oficina y escolar",
    "Tecnolog√≠a"
];

let todos = [];
let catActual = 'Todo';
let zoomTimeout; 
let subCatActual = ''; 

window.openZoom = function(imgSrc) { const m=document.getElementById('zoomModal'); const i=document.getElementById('zoomImg'); i.src=imgSrc; m.classList.add('open'); clearTimeout(zoomTimeout); zoomTimeout=setTimeout(()=>{closeZoom()},4000); }
window.closeZoom = function() { document.getElementById('zoomModal').classList.remove('open'); clearTimeout(zoomTimeout); }
window.onSlideScroll = function(el) { const card=el.closest('.card'); const dots=card.querySelectorAll('.dot'); if(dots.length<2)return; const idx=Math.round(el.scrollLeft/el.offsetWidth); dots.forEach(d=>d.classList.remove('active')); if(dots[idx])dots[idx].classList.add('active'); }
function injectCompanyData() { 
    document.getElementById('footer-envios').textContent=COMPANY_DATA.dataset.envios; 
    document.getElementById('footer-horario').textContent=COMPANY_DATA.dataset.horario; 
}

function renderProductos(lista){
  const grid = document.getElementById('productos');
  if(lista.length === 0){ grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#888;">Sin productos en esta categor√≠a o b√∫squeda.</div>`; return; }
  
  grid.innerHTML = lista.map(p => {
    const tituloBonito = formatearTitulo(p.descripcion); 
    const codigoBonito = formatearCodigo(p.codigo);
    const minOrderQuantity = p.moq || 12; 
    
    let pMayor = parseFloat(p.preciopormayor); if(isNaN(pMayor)) pMayor = 0;
    let pUnidad = parseFloat(p.precioUnidad); if(isNaN(pUnidad)) pUnidad = 0;
    
    let promoBadge = '';
    let precioUnidadHtml = '';
    
    // --- L√ìGICA DE PRECIOS Y DESCUENTO ---
    let mostrarDescuento = false;
    if (pUnidad > 0 && DESCUENTO_UNIDAD_PORCENTAJE > 0) {
        let pUnidadFinal = pUnidad - (pUnidad * (DESCUENTO_UNIDAD_PORCENTAJE / 100));
        // Regla: Descuento solo si NO baja del precio mayorista
        if (pUnidadFinal > pMayor) {
            mostrarDescuento = true;
            promoBadge = `<div class="badge-offer">-${DESCUENTO_UNIDAD_PORCENTAJE}% OFF</div>`;
        }
    }

    if (mostrarDescuento) {
        let pUnidadFinal = pUnidad - (pUnidad * (DESCUENTO_UNIDAD_PORCENTAJE / 100));
        precioUnidadHtml = `
        <div class="price-row unit">
            <span class="price-label">PRECIO POR UNIDAD (-${DESCUENTO_UNIDAD_PORCENTAJE}% OFF):</span>
            <div>
                <span class="price-old">Bs. ${pUnidad.toFixed(2)}</span>
                <span class="price-new">Bs. ${pUnidadFinal.toFixed(2)}</span>
            </div>
        </div>`;
    } else if (pUnidad > 0) {
        precioUnidadHtml = `
        <div class="price-row unit">
            <span class="price-label-normal">PRECIO POR UNIDAD:</span>
            <div class="price-normal">Bs. ${pUnidad.toFixed(2)}</div>
            <div class="promo-text">üî• ¬°Pide en caja tu descuento!</div>
        </div>`;
    } else {
        precioUnidadHtml = `<div class="price-box"><span class="price-val" style="color:#888; font-size:1rem;">PRECIO: CONSULTAR</span></div>`;
    }
    
    // --- BLOQUE MAYORISTA EN 3 L√çNEAS ---
    let mayoristaContentHtml;
    if (pMayor > 0) {
        mayoristaContentHtml = `
            <div class="mayorista-label">
                <i class="bi bi-box-seam-fill"></i> PRECIO POR MAYOR (Min. ${minOrderQuantity} Unid.)
            </div>
            <div class="mayorista-price-row" style="margin-bottom: 0;">
                <span style="color:var(--brand-red); font-weight:900; font-size: 1.2rem; line-height: 1.2; display: block;">Bs. ${pMayor.toFixed(2)}</span>
            </div>
            <div class="mayorista-price-row" style="margin-top: -6px;">
                <span style="font-size: 0.85rem; font-weight: 700; color: #444; line-height: 1.2; display: block;">Cada Unidad</span>
            </div>
        `;
    } else {
        mayoristaContentHtml = `
            <div class="mayorista-label">
                <i class="bi bi-box-seam-fill"></i> PRECIO POR MAYOR (Min. ${minOrderQuantity} Unid.)
            </div>
            <div class="mayorista-price-row">
                <span style="color:var(--brand-red); font-weight:900; font-size: 1.1rem;">COTIZAR</span>
            </div>
        `;
    }

    const mayoristaHtml = `
    <div class="mayorista-cotizar">
        ${mayoristaContentHtml}
    </div>`;

    const tieneFoto2 = p.imagen2 ? true : false;
    const cardId = `card-${p.$id}`;
    let dotHtml = ''; let imagesHtml = '';
    const primaryImage = p.imagen || 'https://via.placeholder.com/300';
    const secondaryImage = p.imagen2 || 'https://via.placeholder.com/300';

    if (tieneFoto2) {
        imagesHtml = `<div class="slide"><img src="${primaryImage}" class="prod-img" onclick="openZoom('${primaryImage}')"></div><div class="slide"><img src="${secondaryImage}" class="prod-img" onclick="openZoom('${secondaryImage}')"></div>`;
        dotHtml = `<div class="dot-container"><div class="dot active"></div><div class="dot"></div></div>`;
    } else {
        imagesHtml = `<div class="slide"><img src="${primaryImage}" class="prod-img" onclick="openZoom('${primaryImage}')"></div>`;
    }

    return `
    <div class="card" id="${cardId}">
      ${promoBadge}
      <div class="img-box"><div class="img-slider" onscroll="onSlideScroll(this)">${imagesHtml}</div>${dotHtml}</div>
      <div class="info">
        <div>
            <h3 class="title">${tituloBonito}</h3>
            <span class="ref">Ref: ${codigoBonito}</span>
        </div>
        
        <div class="prices-container">
            ${precioUnidadHtml}
            ${mayoristaHtml}
        </div>
      </div>
    </div>`;
  }).join('');
}

// --- UTILS ---
function obtenerPalabraClave(txt) {
    if (!txt) return '';
    let primera = txt.trim().split(' ')[0].toLowerCase();
    if (primera.endsWith('es')) primera = primera.slice(0, -2);
    else if (primera.endsWith('s')) primera = primera.slice(0, -1);
    return primera.charAt(0).toUpperCase() + primera.slice(1);
}

function formatearTexto(txt) { if(!txt) return ''; const lower = txt.toLowerCase().trim(); return lower.charAt(0).toUpperCase() + lower.slice(1); }
function formatearTitulo(txt) { if(!txt) return 'Sin Nombre'; const lower = txt.toLowerCase().trim(); return lower.split(' ').map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1)).join(' '); }
function formatearCodigo(txt) { if(!txt) return ''; return txt.toUpperCase().trim(); }
function normalizarTexto(txt) { return (txt || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

// --- RENDERIZADO DE CHIPS ---
function renderSubChips(listaFiltrada){
    const chipsContainer = document.getElementById('sub-chips');
    const busqueda = document.getElementById('searchBox').value.trim();
    
    if (catActual === 'Todo' || listaFiltrada.length === 0 || busqueda) {
        chipsContainer.classList.remove('visible');
        chipsContainer.innerHTML = '';
        return;
    }
    
    let subCategoriasMap = {};
    listaFiltrada.forEach(p => {
        let key = obtenerPalabraClave(p.descripcion);
        subCategoriasMap[key] = (subCategoriasMap[key] || 0) + 1;
    });

    let chipsHtml = Object.keys(subCategoriasMap).sort((a, b) => a.localeCompare(b)).map(key => {
        const activeClass = subCatActual === key ? 'active' : '';
        return `<div class="chip ${activeClass}" onclick="filtrarSubCategoria('${key}', this)">${key}</div>`;
    }).join('');

    if (chipsHtml) {
        chipsContainer.innerHTML = chipsHtml;
        chipsContainer.classList.add('visible');
    } else {
        chipsContainer.classList.remove('visible');
    }
}

// --- L√ìGICA DE FILTRADO (BLINDADA CONTRA CATEGOR√çAS ROTAS) ---
window.filtrarSubCategoria = function(keyNormalizada, chipElement){
    const nuevoSubCat = subCatActual === keyNormalizada ? '' : keyNormalizada;
    subCatActual = nuevoSubCat;

    document.querySelectorAll('#sub-chips .chip').forEach(c => c.classList.remove('active'));
    if (subCatActual) chipElement.classList.add('active');

    // 1. Filtrar por Categor√≠a Principal (Flexible)
    const listaCategoria = catActual === 'Todo' 
        ? todos 
        : todos.filter(p => {
            if (!p.categoria) return false;
            // Busca si "Moda" est√° dentro de "Moda y equipaje" o viceversa
            return normalizarTexto(p.categoria).includes(normalizarTexto(catActual)) || 
                   normalizarTexto(catActual).includes(normalizarTexto(p.categoria));
        });

    // 2. Filtrar por Subcategor√≠a (Primera palabra)
    const listaFinal = subCatActual 
        ? listaCategoria.filter(p => obtenerPalabraClave(p.descripcion) === subCatActual) 
        : listaCategoria;
        
    renderProductos(listaFinal);
}

function renderCategorias(){
    const menu = document.getElementById('menu-cat');
    const mobileMenu = document.getElementById('mobile-cats');
    
    // USAMOS LA LISTA FIJA PARA EL MEN√ö (AS√ç SE VE LIMPIO SIEMPRE)
    const cats = CATEGORIAS_MAESTRAS;
    
    menu.innerHTML = cats.map(c => `<button class="btn-cat ${c==='Todo'?'active':''}" onclick="filtrar('${c}', this)">${c}</button>`).join('');
    mobileMenu.innerHTML = cats.map(c => `<div class="cat-chip ${c==='Todo'?'active':''}" onclick="filtrar('${c}', this)">${c}</div>`).join('');
}

window.filtrar = function(cat, btn){
  subCatActual = ''; 
  document.querySelectorAll('.btn-cat, .cat-chip').forEach(b => b.classList.remove('active'));
  
  if (btn) btn.classList.add('active');
  // Sincronizar (PC y M√≥vil)
  document.querySelectorAll('.btn-cat, .cat-chip').forEach(el => {
      if (el !== btn && el.textContent.trim() === cat) el.classList.add('active');
  });

  catActual = cat;
  document.getElementById('searchBox').value = '';
  
  // FILTRO INTELIGENTE: Busca coincidencias parciales
  const listaFiltrada = cat === 'Todo' 
      ? todos 
      : todos.filter(p => {
          if (!p.categoria) return false;
          return normalizarTexto(p.categoria).includes(normalizarTexto(cat)) || 
                 normalizarTexto(cat).includes(normalizarTexto(p.categoria));
      });
      
  renderProductos(listaFiltrada);
  renderSubChips(listaFiltrada); 
}

document.getElementById('searchBox').addEventListener('keyup', (e) => {
    const query = normalizarTexto(e.target.value);
    
    if (query.length >= 3) {
        const resultados = todos.filter(p => 
            normalizarTexto(p.descripcion).includes(query) ||
            normalizarTexto(p.codigo).includes(query)
        );
        renderProductos(resultados);
        document.getElementById('sub-chips').classList.remove('visible'); 
        return;
    }

    // Volver a la vista de categor√≠a actual
    const listaAFiltrar = catActual === 'Todo' ? todos : todos.filter(p => {
         if (!p.categoria) return false;
         return normalizarTexto(p.categoria).includes(normalizarTexto(catActual)) || 
                normalizarTexto(catActual).includes(normalizarTexto(p.categoria));
    });
    
    renderProductos(listaAFiltrar);
    renderSubChips(listaAFiltrar);
});

async function iniciar(){
  injectCompanyData();
  const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject(PROJECT_ID);
  const db = new Databases(client);
  const grid = document.getElementById('productos');
  
  grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px;"><p style="color:#adb5bd; font-weight:600;">Cargando cat√°logo...</p></div>`;

  try {
    const res = await db.listDocuments(DATABASE_ID, COLLECTION_ID, [Query.limit(5000), Query.orderDesc('$createdAt')]);
    
    if (res.documents && res.documents.length > 0) {
        // FILTRO: Solo disponibles
        todos = res.documents.filter(doc => doc.disponible !== false);
    } else {
        // FALLBACK ELIMINADO para no confundir. Si no hay datos, muestra vac√≠o.
        todos = [];
    }
    
    renderCategorias(); 
    renderProductos(todos); 
    
  } catch(e) { 
    todos = [];
    renderCategorias();
    renderProductos(todos);
    console.error(e); 
    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#d32f2f;">Error de conexi√≥n.</div>`;
  }
}

iniciar();
</script>
</body>
</html>
