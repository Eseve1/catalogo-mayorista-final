<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo Mayorista - Cotizar (resaltado al agregar)</title>

  <!-- Fuentes y CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root { --green-ws:#23bf3d; --accent:#2363ec; --bg:#f3f2ef; --highlight: #ffeedd; }

    body { background: var(--bg); font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding-bottom: 120px; }

    .header-clean{
      background:var(--accent);
      background-image: linear-gradient(80deg,var(--accent) 50%,#0e214d 150%);
      color:#fff; padding:12px 16px; position:sticky; top:0; z-index:1000;
      box-shadow:0 4px 10px rgba(32,65,180,0.11);
    }

    .categorias-wrapper{ background:#fff; padding:8px 0; position:sticky; top:56px; z-index:900; overflow-x:auto; white-space:nowrap; box-shadow:0 2px 5px rgba(0,0,0,0.04); }

    .btn-cat{ background:#f8f9fa; color:#222; padding:7px 16px; border-radius:18px; margin:0 6px; font-weight:700; text-transform:capitalize; border:1px solid #ebeaeb; font-size:0.95rem; }
    .btn-cat.active{ background:var(--accent); color:#fff; border-color:#1450b9; box-shadow:0 2px 6px #2363ec20; }

    .card-image-focus{
      background:#fffdfb; border:1px solid #e9eaea; border-radius:12px;
      box-shadow:0 4px 20px rgba(37,48,97,0.06); transition:box-shadow .18s, transform .14s, border-left .18s, background .2s;
      display:flex; flex-direction:column; height:100%; position:relative;
    }
    .card-image-focus:hover{ transform:translateY(-4px); box-shadow:0 10px 22px rgba(18,94,176,0.10); }

    /* ESTILO: cuando el producto está seleccionado para cotizar, "dale vida" con color y brillo */
    .card-image-focus.card-selected {
      border-left: 6px solid var(--green-ws);
      background: linear-gradient(90deg, rgba(35,191,61,0.04), rgba(255,255,255,0.0));
      box-shadow: 0 10px 30px rgba(35,191,61,0.14);
      transform: translateY(-6px) scale(1.006);
      animation: subtlePulse 1.6s ease-in-out 1;
    }

    @keyframes subtlePulse {
      0% { box-shadow: 0 6px 18px rgba(35,191,61,0.12); }
      50% { box-shadow: 0 12px 30px rgba(35,191,61,0.20); }
      100% { box-shadow: 0 6px 18px rgba(35,191,61,0.12); }
    }

    .oferta-cinta{ position:absolute; left:-36px; top:14px; z-index:20; background:linear-gradient(90deg,#ea4838 80%,#fca800 100%); color:#fff; padding:4px 34px; transform:rotate(-28deg); font-weight:800; font-size:.95rem; border-radius:6px; box-shadow:0 6px 12px rgba(234,72,56,0.18); }
    .badge-nuevo{ position:absolute; left:0; top:12px; z-index:15; background:linear-gradient(90deg,#ecbf28 55%,#ed9f16 100%); padding:5px 14px; font-weight:800; border-radius:0 8px 8px 0; color:#222; }

    .moq-badge { position:absolute; top:8px; right:8px; z-index:25; background:#ff8300e6; color:#fff; padding:6px 10px; font-weight:800; font-size:0.82rem; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.08); }

    /* imagen - mostrar completa */
    .img-zona{ position:relative; z-index:1; height:220px; background:#fff; border-bottom:1px solid #eee; padding:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:10px; }
    .img-zona img, .carousel-item img { width:auto; max-width:100%; height:100%; max-height:100%; object-fit:contain; object-position:center; display:block; border-radius:8px; opacity:0; transition:opacity .36s; }
    .img-zona img[src], .carousel-item img[src] { opacity:1; }

    .info-zona{ padding:12px; display:flex; flex-direction:column; gap:8px; flex-grow:1; }
    .titulo-prod{ font-size:1.02rem; font-weight:700; color:#191e2f; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:1.2em; }
    .codigo-text{ color:#676970; font-size:0.95rem; }

    .precio-unidad-label{ font-size:0.78rem; color:#8f8f8f; margin-bottom:2px; }
    .precio-unidad-valor{ color:#9da0a2; text-decoration:line-through; font-weight:600; font-size:0.88rem; }

    .precio-mayor-valor{ font-size:1.05rem; color:#d94d3f; font-weight:800; line-height:1; }
    .precio-mayor-label{ font-size:0.8rem; color:#c28813; font-weight:700; }

    .action-block{ position:relative; z-index:2; margin-top:6px; display:flex; flex-direction:column; align-items:center; gap:8px; }

    .inline-qty { display:inline-flex; align-items:center; gap:8px; }
    .quote-qty-input { width:72px; padding:6px 8px; border-radius:8px; border:1px solid #d6d6d6; text-align:center; }
    .color-select { padding:6px 8px; border-radius:8px; border:1px solid #d6d6d6; min-width:120px; }

    .add-quote-btn { background:#fff; border:1px dashed #c6c6c6; color:#333; padding:6px 10px; border-radius:10px; font-weight:600; font-size:0.88rem; display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
    .add-quote-btn.selected { background:#e6f9ea; border:1px solid #1aa242; color:#0a6b1a; }

    /* Floating CTA with "Bs." */
    .floating-cta { position:fixed; right:18px; bottom:18px; z-index:1200; background:var(--green-ws); color:#fff; border-radius:999px; padding:12px 18px; font-weight:800; display:inline-flex; align-items:center; gap:10px; box-shadow:0 8px 28px rgba(35,191,61,0.18); cursor:pointer; border:none; }
    .floating-cta .bs { background: #fff; color: #1d1d1d; padding:3px 8px; border-radius:8px; font-weight:700; }

    .modal-body .selected-list { max-height:260px; overflow:auto; margin-bottom:12px; }
    .selected-item { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:6px 4px; border-bottom:1px solid #efefef; }
    .selected-item .left { flex:1; min-width:0; }
    .selected-item .right { text-align:right; width:200px; }

    .qty-controls { display:inline-flex; gap:6px; align-items:center; }
    .qty-controls button { padding:3px 8px; border-radius:6px; border:1px solid #d0d0d0; background:#fff; cursor:pointer; }
    .remove-item { background:transparent; border:none; color:#cc3333; font-weight:700; cursor:pointer; }

    @media (max-width:768px){ .img-zona{ height:260px; } .precio-mayor-valor{ font-size:1.2rem; } }
    @media (max-width:450px){ .img-zona{ height:200px; } .titulo-prod{ font-size:1rem; } .floating-cta { right:12px; bottom:12px; padding:10px 14px; } }
  </style>
</head>
<body>
  <div class="header-clean d-flex align-items-center">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="fw-bold"><i class="bi bi-person-workspace"></i> Catálogo MAYORISTA</div>
      <div class="badge bg-light text-secondary border" id="contador">0 Productos</div>
    </div>
  </div>

  <div class="categorias-wrapper" id="menu-cat"></div>

  <div class="container-fluid py-2" style="text-align:right;">
    <input id="searchBox" placeholder="Buscar producto..." class="form-control" style="max-width:320px; display:inline-block;">
  </div>

  <div class="container-fluid px-2 mt-3">
    <div id="productos" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-3">
      <div class="col-12 text-center py-5"><div class="spinner-border text-secondary" role="status"></div></div>
    </div>
  </div>

  <!-- Floating CTA (single) with Bs. -->
  <button id="floatingCta" class="floating-cta" type="button" data-bs-toggle="modal" data-bs-target="#cotizarModal" title="Cotizar ahora">
    <span class="bs">Bs.</span>
    Cotizar ahora
    <span id="selectedCount" class="count" style="background:#fff;color:#111;padding:3px 7px;border-radius:8px;margin-left:6px;font-weight:700;">0</span>
  </button>

  <!-- Modal: Cotizar -->
  <div class="modal fade" id="cotizarModal" tabindex="-1" aria-labelledby="cotizarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cotizarModalLabel">Enviar cotización por WhatsApp</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>Productos seleccionados (ajusta cantidades o colores si quieres):</p>

          <div class="selected-list" id="selectedList">
            <!-- items dinámicos -->
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div><strong>Total estimado:</strong></div>
            <div><strong id="selectedTotal">Bs. 0</strong></div>
          </div>

          <label for="cotizarText" class="form-label">Mensaje (opcional):</label>
          <textarea id="cotizarText" class="form-control" placeholder="Escribe tu mensaje..."></textarea>
          <div class="form-text mt-2">El mensaje final incluirá los códigos, color, cantidades y total estimado.</div>
        </div>
        <div class="modal-footer">
          <button id="clearSelection" type="button" class="btn btn-outline-secondary">Limpiar selección</button>
          <button id="sendWhatsApp" type="button" class="btn btn-success">Enviar por WhatsApp</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Appwrite client -->
  <script type="module">
    import { Client, Databases } from "https://cdn.jsdelivr.net/npm/appwrite@14.0.1/+esm";

    const MI_WHATSAPP = "59161333335";
    const DEFAULT_MOQ = "6 UNID";
    let todosLosProductos = [];
    // Map key = `${codigo}|${color}` => { codigo, descripcion, color, precio (number), qty }
    let selectedForQuote = new Map();

    function parsePriceToNumber(raw) {
      if (raw === undefined || raw === null) return 0;
      const s = String(raw).replace(/[^\d.,-]/g, '').replace(',', '.');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function formatCurrency(n) {
      return 'Bs. ' + Number(n).toLocaleString('es-VE', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function updateSelectionUI() {
      const count = selectedForQuote.size;
      document.getElementById('selectedCount').innerText = count;

      const list = document.getElementById('selectedList');
      list.innerHTML = '';
      let total = 0;
      selectedForQuote.forEach((item, key) => {
        const subtotal = item.precio * item.qty;
        total += subtotal;
        const el = document.createElement('div');
        el.className = 'selected-item';
        el.dataset.key = key;
        el.innerHTML = `
          <div class="left">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.descripcion}</div>
            <div style="font-size:0.9rem;color:#666">
              REF: ${item.codigo} • Color:
              <input type="text" value="${item.color || ''}" data-key="${key}" class="form-control form-control-sm color-edit-input" style="display:inline-block; width:120px; margin-left:6px;" />
            </div>
          </div>
          <div class="right">
            <div style="font-weight:700">${formatCurrency(item.precio)}</div>
            <div style="margin-top:6px;display:flex;align-items:center;justify-content:flex-end;gap:8px;">
              <div class="qty-controls">
                <button class="qty-decr" data-key="${key}">-</button>
                <span style="padding:0 8px;" id="qty-${key}">${item.qty}</span>
                <button class="qty-incr" data-key="${key}">+</button>
              </div>
              <button class="remove-item" data-key="${key}" title="Quitar">✕</button>
            </div>
            <div style="font-size:0.9rem;color:#444;margin-top:6px;">Subtotal: <strong>${formatCurrency(subtotal)}</strong></div>
          </div>
        `;
        list.appendChild(el);
      });

      document.getElementById('selectedTotal').innerText = formatCurrency(total);

      // attach events
      list.querySelectorAll('.qty-incr').forEach(b => b.addEventListener('click', (e) => {
        const k = e.currentTarget.dataset.key; const it = selectedForQuote.get(k);
        if (!it) return;
        it.qty += 1;
        selectedForQuote.set(k, it);
        // sync card qty input if present
        document.querySelectorAll(`.add-quote-btn`).forEach(btn => {
          const code = btn.dataset.codigo;
          const color = decodeURIComponent(btn.dataset.color || '');
          const keyBtn = `${code}|${color}`;
          if (keyBtn === k) {
            const input = btn.closest('.info-zona').querySelector('.quote-qty-input');
            if (input) input.value = it.qty;
          }
        });
        updateSelectionUI();
      }));
      list.querySelectorAll('.qty-decr').forEach(b => b.addEventListener('click', (e) => {
        const k = e.currentTarget.dataset.key; const it = selectedForQuote.get(k);
        if (!it) return;
        if (it.qty > 1) {
          it.qty -= 1;
          selectedForQuote.set(k, it);
          // sync card qty input
          document.querySelectorAll(`.add-quote-btn`).forEach(btn => {
            const code = btn.dataset.codigo;
            const color = decodeURIComponent(btn.dataset.color || '');
            const keyBtn = `${code}|${color}`;
            if (keyBtn === k) {
              const input = btn.closest('.info-zona').querySelector('.quote-qty-input');
              if (input) input.value = it.qty;
            }
          });
        } else {
          selectedForQuote.delete(k);
          // untoggle button + remove highlight
          document.querySelectorAll('.add-quote-btn').forEach(btn => {
            const code = btn.dataset.codigo;
            const color = decodeURIComponent(btn.dataset.color || '');
            const keyBtn = `${code}|${color}`;
            if (keyBtn === k) {
              btn.classList.remove('selected');
              const card = btn.closest('.card-image-focus');
              if (card) card.classList.remove('card-selected');
            }
          });
        }
        updateSelectionUI();
      }));
      list.querySelectorAll('.remove-item').forEach(b => b.addEventListener('click', (e) => {
        const k = e.currentTarget.dataset.key;
        selectedForQuote.delete(k);
        // untoggle buttons in grid and reset qty inputs
        document.querySelectorAll('.add-quote-btn').forEach(btn => {
          const code = btn.dataset.codigo;
          const color = decodeURIComponent(btn.dataset.color || '');
          const keyBtn = `${code}|${color}`;
          if (keyBtn === k) {
            btn.classList.remove('selected');
            const input = btn.closest('.info-zona').querySelector('.quote-qty-input');
            if (input) input.value = 1;
            const card = btn.closest('.card-image-focus');
            if (card) card.classList.remove('card-selected');
          }
        });
        updateSelectionUI();
      }));

      // color edit inputs in modal: update map on change
      list.querySelectorAll('.color-edit-input').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const k = e.currentTarget.dataset.key;
          const it = selectedForQuote.get(k);
          if (!it) return;
          it.color = e.currentTarget.value.trim();
          selectedForQuote.set(k, it);
        });
      });

      // update textarea default message if user hasn't typed custom
      const ta = document.getElementById('cotizarText');
      if (!ta.value || ta.value.trim().startsWith('Hola, quiero cotizar')) {
        const lines = [];
        selectedForQuote.forEach((it) => {
          lines.push(`${it.codigo} (${it.color || 'N/A'}) x${it.qty} @ ${formatCurrency(it.precio)} = ${formatCurrency(it.precio * it.qty)}`);
        });
        const base = lines.length
          ? `Hola, quiero cotizar los siguientes productos:\n${lines.join('\n')}\nTotal estimado: ${formatCurrency(total)}\n\nDetalles adicionales:`
          : 'Hola, quiero cotizar. Indica productos o copia/pega referencias aquí.';
        // don't overwrite if user edited
        if (!ta.value) ta.value = base;
      }
    }

    async function iniciar(){
      const divProd = document.getElementById('productos');
      const menuCat = document.getElementById('menu-cat');
      const spanCount = document.getElementById('contador');

      try{
        const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('692ee6b70012153cd33c');
        const databases = new Databases(client);
        const res = await databases.listDocuments('692ee774002e9a3c8601','catalogo');

        todosLosProductos = res.documents || [];
        spanCount.innerText = `${todosLosProductos.length} Productos`;

        const categorias = new Set();
        todosLosProductos.forEach(p => categorias.add(p.categoria || 'General'));
        let htmlMenu = `<button class="btn-cat active" onclick="window.filtrar('Todo', this)">Todo</button>`;
        categorias.forEach(cat => htmlMenu += `<button class="btn-cat" onclick="window.filtrar('${cat}', this)">${cat}</button>`);
        menuCat.innerHTML = htmlMenu;

        renderizar(todosLosProductos);

      }catch(err){
        divProd.innerHTML = `<div class="text-danger text-center p-4">No se pudo conectar con el catálogo.<br><small>${err.message}</small><br><button onclick="location.reload()" class="btn btn-outline-primary mt-2">Reintentar</button></div>`;
        console.error("Error iniciar:", err);
      }
    }

    // Use codigo|color as unique key so same code with different color can be separate
    function toggleSelectFromButton(btn) {
      const codigo = btn.dataset.codigo;
      const desc = decodeURIComponent(btn.dataset.desc || '');
      // color prefer from select (if exists), else from button dataset
      const colorSelect = btn.closest('.info-zona').querySelector('.color-select');
      const colorFromInput = colorSelect ? (colorSelect.value || colorSelect.value.trim()) : decodeURIComponent(btn.dataset.color || '');
      const color = colorFromInput || '';
      const rawPriceBo = btn.dataset.pricebo || btn.dataset.price || '0';
      const precio = parsePriceToNumber(rawPriceBo);
      const qtyInput = btn.closest('.info-zona').querySelector('.quote-qty-input');
      const qty = Math.max(1, parseInt(qtyInput ? qtyInput.value : 1) || 1);

      if (!codigo) return;
      const key = `${codigo}|${color}`;
      const cardEl = btn.closest('.card-image-focus');

      if (selectedForQuote.has(key)) {
        selectedForQuote.delete(key);
        btn.classList.remove('selected');
        if (cardEl) cardEl.classList.remove('card-selected');
        if (qtyInput) qtyInput.value = 1;
      } else {
        selectedForQuote.set(key, { codigo, descripcion: desc, color: color, precio, qty });
        btn.classList.add('selected');
        if (cardEl) cardEl.classList.add('card-selected');
      }
      updateSelectionUI();
    }

    function renderizar(lista){
      const divProd = document.getElementById('productos');
      if(!lista || lista.length === 0){
        divProd.innerHTML = '<div class="col-12 text-center text-muted py-5">No hay productos.</div>';
        return;
      }
      let html = '';
      lista.forEach((p, index) => {
        const codigo = p.codigo || 'S/C';
        const desc = p.descripcion || '';
        const precioU = p.precioUnidad || '0';
        const precioM = p.preciopormayor || '0';
        const precioBOraw = p.precioBO || p.precioBol || p.precioBolivianos || p.preciopormayor || precioM || precioU;
        const precioBO = precioBOraw;
        let colorsArr = [];
        if (Array.isArray(p.colores) && p.colores.length) colorsArr = p.colores;
        else if (Array.isArray(p.colors) && p.colors.length) colorsArr = p.colors;
        else if (p.color) colorsArr = [p.color];
        else if (p.color1) colorsArr = [p.color1];
        else if (p.colores_text) colorsArr = String(p.colores_text).split(',').map(s => s.trim()).filter(Boolean);
        const moq = p.moq || DEFAULT_MOQ;

        const badgeNuevo = p.nuevo ? `<div class="badge-nuevo">¡Nuevo!</div>` : '';
        const ofertaCinta = p.oferta ? `<div class="oferta-cinta">¡OFERTA!</div>` : '';

        const imagenes = [];
        if(p.imagen) imagenes.push(p.imagen);
        if(p.imagen2) imagenes.push(p.imagen2);
        if(p.imagen3) imagenes.push(p.imagen3);
        if(imagenes.length === 0) imagenes.push('https://via.placeholder.com/600x400?text=SIN+FOTO');

        let htmlImagen = '';
        if(imagenes.length > 1){
          let items = '';
          imagenes.forEach((u,i) => {
            items += `<div class="carousel-item ${i===0?'active':''}"><img src="${u}" alt="Foto ${i+1}: ${desc}" loading="lazy"></div>`;
          });
          htmlImagen = `<div id="carousel-${index}" class="carousel slide" data-bs-interval="false"><div class="carousel-inner">${items}</div><button class="carousel-control-prev" type="button" data-bs-target="#carousel-${index}" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button><button class="carousel-control-next" type="button" data-bs-target="#carousel-${index}" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button></div>`;
        } else {
          htmlImagen = `<img src="${imagenes[0]}" alt="${desc||codigo}" loading="lazy">`;
        }

        // Build color selector
        let colorSelectorHtml = '';
        if (colorsArr.length > 0) {
          colorSelectorHtml = `<select class="color-select">` + colorsArr.map(c => `<option value="${c}">${c}</option>`).join('') + `</select>`;
        } else {
          colorSelectorHtml = `<input class="color-select form-control form-control-sm" placeholder="Escribe color" style="width:140px;" />`;
        }

        html += `
          <div class="col">
            <div class="card-image-focus position-relative">
              ${badgeNuevo}
              ${ofertaCinta}
              <div class="moq-badge">MIN. ${moq}</div>

              <div class="img-zona">${htmlImagen}</div>

              <div class="info-zona">
                <h5 class="titulo-prod mb-1">${desc}</h5>
                <div class="codigo-text mb-2">REF: ${codigo}${colorsArr.length ? ' • ' + colorsArr[0] : ''}</div>

                <div class="action-block">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <p class="precio-unidad-label mb-0">Precio Venta</p>
                      <div class="precio-unidad-valor">Bs. ${precioU}</div>
                    </div>
                    <div class="text-end">
                      <div class="precio-mayor-valor">Bs. ${precioM}</div>
                      <div class="precio-mayor-label">PRECIO MAYOR</div>
                    </div>
                  </div>

                  <div style="width:100%;display:flex;justify-content:center;margin-top:8px;gap:10px;align-items:center;">
                    <div class="inline-qty">
                      <input type="number" class="quote-qty-input" min="1" value="1" />
                    </div>

                    <div>
                      ${colorSelectorHtml}
                    </div>

                    <div>
                      <button class="add-quote-btn" data-codigo="${codigo}" data-desc="${encodeURIComponent(desc)}" data-color="${encodeURIComponent(colorsArr[0] || '')}" data-pricebo="${encodeURIComponent(precioBO)}">
                        <i class="bi bi-plus-lg"></i> Agregar
                      </button>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        `;
      });

      divProd.innerHTML = html;

      // attach listeners for add-quote-btn
      document.querySelectorAll('.add-quote-btn').forEach(btn => {
        btn.dataset.desc = decodeURIComponent(btn.dataset.desc || '');
        btn.dataset.color = decodeURIComponent(btn.dataset.color || '');
        btn.dataset.pricebo = decodeURIComponent(btn.dataset.pricebo || '');
        btn.addEventListener('click', (ev) => {
          toggleSelectFromButton(ev.currentTarget);
        });
      });

      // restore selected state styling if items already selected
      document.querySelectorAll('.add-quote-btn').forEach(btn => {
        const code = btn.dataset.codigo;
        const color = decodeURIComponent(btn.dataset.color || '');
        const key = `${code}|${color}`;
        if (selectedForQuote.has(key)) {
          btn.classList.add('selected');
          const card = btn.closest('.card-image-focus');
          if (card) card.classList.add('card-selected');
          const it = selectedForQuote.get(key);
          const input = btn.closest('.info-zona').querySelector('.quote-qty-input');
          if (input) input.value = it.qty;
        } else {
          btn.classList.remove('selected');
        }
      });

      updateSelectionUI();
    }

    // send WhatsApp: include codes, colors, quantities and total
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'sendWhatsApp') {
        const ta = document.getElementById('cotizarText');
        const userText = ta.value.trim();

        let summaryLines = [];
        let total = 0;
        selectedForQuote.forEach(it => {
          summaryLines.push(`${it.codigo} • ${it.color || 'N/A'} • x${it.qty} = ${formatCurrency(it.precio * it.qty)}`);
          total += it.precio * it.qty;
        });
        const summary = summaryLines.length
          ? `Productos:\n${summaryLines.join('\n')}\nTotal estimado: ${formatCurrency(total)}\n\n`
          : '';

        const finalMessage = summary + (userText || 'Hola, quiero cotizar estos productos.');
        if (!selectedForQuote.size) {
          if (!confirm('No hay productos seleccionados. ¿Deseas enviar un mensaje libre por WhatsApp?')) return;
        }
        const waLink = `https://wa.me/${MI_WHATSAPP}?text=${encodeURIComponent(finalMessage)}`;
        window.open(waLink, '_blank');
      }

      // clear selection
      if (e.target && e.target.id === 'clearSelection') {
        selectedForQuote.clear();
        document.querySelectorAll('.add-quote-btn.selected').forEach(b => b.classList.remove('selected'));
        document.querySelectorAll('.card-image-focus.card-selected').forEach(c => c.classList.remove('card-selected'));
        document.querySelectorAll('.quote-qty-input').forEach(i => i.value = 1);
        document.querySelectorAll('.color-select').forEach(s => { if (s.tagName === 'INPUT') s.value = ''; });
        updateSelectionUI();
      }
    });

    window.filtrar = function(categoria, btn){
      document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('active'));
      if(btn) btn.classList.add('active');
      if(categoria === 'Todo') renderizar(todosLosProductos);
      else renderizar(todosLosProductos.filter(p => (p.categoria || 'General') === categoria));
    };

    // Buscador + init
    document.addEventListener('DOMContentLoaded', () => {
      const searchBox = document.getElementById('searchBox');
      if(searchBox){
        searchBox.addEventListener('input', function(){
          const q = this.value.toLowerCase().trim();
          if(!q){ renderizar(todosLosProductos); return; }
          const filtered = todosLosProductos.filter(p => (p.descripcion||'').toLowerCase().includes(q) || (p.codigo||'').toLowerCase().includes(q));
          renderizar(filtered);
          document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('active'));
        });
      }
      iniciar();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
